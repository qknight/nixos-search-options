<html>
<head>
<!--  
<script type="text/javascript" src="bootstrap.min.js"></script> 
  <link rel="stylesheet" href="bootstrap.min.css" />
-->

<link rel="stylesheet" href="bootstrap-responsive.min.css" />
<link rel="stylesheet" href="nixos-site.css" type="text/css" />

<style type="text/css">
#info {
   display: inline-block;
   padding: 2px 4px;
   font-size: 11.844px;
   font-weight: bold;
   line-height: 14px;
   color: #fff;
   background-color: #468847;
   text-shadow: 0 -1px 0 rgba(0,0,0,0.25);
   white-space: nowrap;
   vertical-align: baseline;
};
</style>


</head>
 <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
<h1> Search NixOS options</h1>

<div id="obbb">
<div id="bbb">
<input name="query" type="text" class="search-query span3" placeholder="Search by name or description" id="search" value="" autofocus="autofocus" style="background: #fff url('share-sprite-new.png') no-repeat -269px -92px !important; padding-left: 22px !important;width: 288px; height: 22px; margin: 0px"> <div id="info">?</div> (options in selection)
</div>
<br>
<input type="checkbox" id="nameCB" checked="true" onchange="update()">path,
<input type="checkbox" id="descriptionCB" checked="true" onchange="update()">description,
<input type="checkbox" id="defaultCB" checked="true" onchange="update()">default,
<input type="checkbox" id="exampleCB" checked="true" onchange="update()">example,
<input type="checkbox" id="declarationsCB" checked="true" onchange="update()">declarations
</div>

<br>
<br>

<div id="result"></a>

<script type="text/javascript">

var optionsList;

var optionsJSON = "./options.json";
var nixpkgsRepo = "https://github.com/NixOS/nixpkgs/tree/master/";
var searchField;

function toggle_visibility(id) {
       var e = document.getElementById(id);
       if(e.style.display == '')
          e.style.display = 'none';
       else
          e.style.display = '';
}

function populate() {
    var dom = "";
    optionsList.forEach(function(value) {

      var innerTagId = value.name + '-inner';
      var name = value.name.replace('<', '&lt;').replace('>', '&gt;');
      dom += '' +
        '<div id="' + value.name + '">' +
          '<dt><span class="term">' +
            '<a class="term" href="javascript:void(0);" shape="rect" onclick="toggle_visibility(\'' + innerTagId + '\')"><code class="option">' +
              name +
            '</code></a>' +
          '</span></dt>' +
          '<dd id="' + innerTagId + '">' +
            '<p>' + value.description + '</p>';

      // Write the default value if it exists.
      if (value.default)
        dom += '' +
            '<p><span class="emphasis"><em>Default:</em></span> <code class="literal">' + value.default + '</code></p>';

      // Write the example value if it exists.
      if (value.example)
        dom += '' +
            '<p><span class="emphasis"><em>Example:</em></span> <code class="literal">' + value.example + '</code></p>';

      // If we know any of the files in which this option is declared.
      if (value.declarations.length) {
        dom += '' +
            '<table class="simplelist" border="0" summary="Simple list"><tbody>';
        // Then list and align all the declarations.
        for (var i = 0; i < value.declarations.length; i++) {
          dom += '' +
              '<tr><td rowspan="1" colspan="1"><code class="filename">' +
                 '<a class="filename" href="' + nixpkgsRepo + value.declarations[i] + '" target="_top" shape="rect">' +
                   ' &lt;' + value.declarations[i] + '&gt; ' +
                 '</a>' +
              '</code></td></tr>';
        }
        dom += '' +
            '</tbody></table>';
      }
      dom += '' +
          '</dd> ' +
        '</div>';
    });

    document.getElementById("result").innerHTML = dom;

    optionsList.forEach(function(value) {
      var n = value.name + "-inner";
      document.getElementById(n).style.display = "none";
    });
}

function init() {
  // Find the search field in the document.
  searchField = document.getElementById("search");

  function onError(e) {
    console.log( "error downloading or parsing json" );
  }

  function onLoad(e) {
    console.log("received json");
    optionsList = JSON.parse(req.responseText);
    console.log("parsed json");

    // Convert the content of the JSON file into DOM elements.
    populate();

    // Once the content is available, call the update function when the search
    // field content is changed.
    searchField.oninput = update;

    // In case the user has already typed some input, call the update function
    // to update the output.
    update();
  }

  // Request the JSON file produced while generating nixos manual.
  var req = new XMLHttpRequest();
  req.open("GET", optionsJSON, true);
  req.onload = onLoad;
  req.onerror = onError;
  req.send(null);
}

function partitionSearch() {
  var words = searchField.value.toLowerCase().split(/ +/).filter(Boolean);

  if (!words.length)
    return { match: optionsList, miss: [] };

  var match = [];
  var miss = [];

  var nameCB = (document.getElementById("nameCB").checked == true);
  var descriptionCB = (document.getElementById("descriptionCB").checked == true);
  var defaultCB = (document.getElementById("defaultCB").checked == true);
  var exampleCB = (document.getElementById("exampleCB").checked == true);
  var declarationsCB = (document.getElementById("declarationsCB").checked == true);

  var len = optionsList.length;
  for (var i = 0; i < len; i++) {
    var value = optionsList[i];

    var name = value.name + "";
    var description = (value.description || "") + "";
    var default_ = (value["default"] || "") + "";
    var example = (value.example || "") + "";
    var declarations = (value.declarations || "") + "";

    function matchWord(word) {
      return((nameCB && (name.toLowerCase().indexOf(word) != -1))
          || (descriptionCB && (description.toLowerCase().indexOf(word) != -1))
          || (defaultCB && (default_.toLowerCase().indexOf(word) != -1))
          || (exampleCB && (example.toLowerCase().indexOf(word) != -1))
          || (declarationsCB && (declarations.toLowerCase().indexOf(word) != -1)));
    };

    if (words.every(matchWord))
      match.push(value);
    else
      miss.push(value);
  }

  return { match: match, miss: miss };
}

function update() {
    var partition = partitionSearch();

    // finally display those left
    partition.miss.forEach(function(value) {
      document.getElementById(value.name).style.display = "none";
    });

    partition.match.forEach(function(value) {
      document.getElementById(value.name).style.display = "";
    });

    document.getElementById("info").innerHTML = partition.match.length;
}

// Call the init function once the body is loaded.
document.getElementsByTagName("body")[0].onload = init;

</script>

</body>
</html>
